{{ define "main" }}

<div class="friends-board">

  {{ partial "breadcrumbs.html" . }}

  <header class="friends-header">
    <h1 class="friends-title">{{ .Title }}</h1>
    {{ with .Content }}
    <div class="friends-description">
      {{ . }}
    </div>
    {{ end }}
  </header>

  {{ $friends := site.Data.friends }}

  {{ if $friends }}
  <section class="friends-grid">
    {{ range sort $friends "name" }}
    {{/* 优先使用手动设置的头像，缺省时尝试使用本地缓存的 favicon */}}
    {{ $rawAvatar := trim (default "" .avatar) " " }}
    {{ $avatarURL := "" }}
    {{ if ne $rawAvatar "" }}
    {{ if or (hasPrefix $rawAvatar "http://") (hasPrefix $rawAvatar "https://") }}
    {{ $avatarURL = $rawAvatar }}
    {{ else }}
    {{ $avatarURL = relURL $rawAvatar }}
    {{ end }}
    {{ else }}
    {{ $host := "" }}
    {{ with .url }}
    {{ $parsed := urls.Parse . }}
    {{ if $parsed.Host }}
    {{ $host = $parsed.Host }}
    {{ else }}
    {{ $trimmed := trim . "/" }}
    {{ if ne $trimmed "" }}
    {{ $host = index (split $trimmed "/") 0 }}
    {{ end }}
    {{ end }}
    {{ end }}
    {{ $host = lower (replaceRE ":.*$" "" $host) }}
    {{ if ne $host "" }}
    {{ $hostKey := replace $host ":" "_" }}
    {{ $localAvatar := "" }}
    {{ $iconExts := slice "png" "jpg" "jpeg" "ico" "svg" "webp" }}
    {{ range $iconExts }}
    {{ if eq $localAvatar "" }}
    {{ $candidate := printf "static/friends/icons/%s.%s" $hostKey . }}
    {{ if fileExists $candidate }}
    {{ $localAvatar = printf "/friends/icons/%s.%s" $hostKey . }}
    {{ end }}
    {{ end }}
    {{ end }}
    {{ if ne $localAvatar "" }}
    {{ $avatarURL = relURL $localAvatar }}
    {{ end }}
    {{ end }}
    {{ end }}
    {{ $hasAvatar := ne $avatarURL "" }}
    {{ $initial := "" }}
    {{ with .name }}
    {{ if gt (len .) 0 }}
    {{ $initial = slicestr . 0 1 }}
    {{ end }}
    {{ end }}
    <a class="friend-card" href="{{ .url }}" target="_blank" rel="noopener">
      <div class="friend-avatar">
        {{ if $hasAvatar }}
        <img src="{{ $avatarURL }}" alt="{{ .name }}">
        {{ else }}
        <span class="friend-avatar-placeholder">{{ $initial }}</span>
        {{ end }}
      </div>
      <div class="friend-body">
        <h2 class="friend-name">{{ .name }}</h2>
        {{ with .desc }}
        <p class="friend-desc">{{ . }}</p>
        {{ end }}
        {{ with .tags }}
        <ul class="friend-tags">
          {{ range . }}
          <li>{{ . }}</li>
          {{ end }}
        </ul>
        {{ end }}
      </div>
      <span class="friend-arrow" aria-hidden="true">&rarr;</span>
    </a>
    {{ end }}
  </section>
  {{ else }}
  <p class="friends-empty">暂时还没有好友链接，欢迎来敲门。</p>
  {{ end }}

  {{ with .Params.exchange }}
  <section class="friends-exchange">
    <h2 class="friends-exchange-heading">{{ .heading | default "想要交换友链？" }}</h2>
    {{ with .intro }}
    <p class="friends-exchange-lead">{{ . }}</p>
    {{ end }}
    {{ with .items }}
    <ul class="friends-exchange-list">
      {{ range . }}
      {{ $value := .value }}
      {{ if $value }}
      {{ $placeholder := default "点击复制后获取" .placeholder }}
      {{ $label := default "复制" .copyLabel }}
      {{ $success := default "已复制" .copySuccess }}
      <li class="friends-exchange-item">
        <span class="friends-exchange-label">{{ .label }}</span>
        <div class="friends-exchange-content">
          {{ if .conceal }}
          <span class="friends-exchange-value is-concealed" data-placeholder="{{ $placeholder }}" data-success="{{ $success }}">{{ $placeholder }}</span>
          {{ else if .link }}
          <a class="friends-exchange-value" href="{{ $value }}" target="_blank" rel="noopener">{{ .display | default $value }}</a>
          {{ else }}
          <span class="friends-exchange-value">{{ .display | default $value }}</span>
          {{ end }}
          <button class="friends-copy-button" type="button" data-copy="{{ $value }}" data-label="{{ $label }}" data-success="{{ $success }}">{{ $label }}</button>
        </div>
      </li>
      {{ end }}
      {{ end }}
    </ul>
    {{ end }}
  </section>
  {{ end }}

</div>

<script>
document.addEventListener('click', function (event) {
  var button = event.target.closest('.friends-copy-button');
  if (!button) return;

  var value = button.getAttribute('data-copy');
  if (!value) return;

  var defaultLabel = button.getAttribute('data-label') || '复制';
  var successLabel = button.getAttribute('data-success') || '已复制';

  var handleSuccess = function () {
    var content = button.closest('.friends-exchange-content');
    button.classList.add('is-copied');
    button.textContent = successLabel;

    if (content) {
      var valueNode = content.querySelector('.friends-exchange-value');
      if (valueNode && valueNode.classList.contains('is-concealed')) {
        var successPlaceholder = valueNode.getAttribute('data-success') || successLabel;
        valueNode.textContent = successPlaceholder;
        valueNode.classList.add('is-copied');
      }
    }

    window.setTimeout(function () {
      button.classList.remove('is-copied');
      button.textContent = defaultLabel;
      if (content) {
        var valueNode = content.querySelector('.friends-exchange-value');
        if (valueNode && valueNode.classList.contains('is-concealed')) {
          valueNode.textContent = valueNode.getAttribute('data-placeholder') || '点击复制后获取';
          valueNode.classList.remove('is-copied');
        }
      }
    }, 2000);
  };

  var handleFailure = function () {
    button.classList.add('is-error');
    button.textContent = '复制失败';
    window.setTimeout(function () {
      button.classList.remove('is-error');
      button.textContent = defaultLabel;
    }, 2000);
  };

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(value).then(handleSuccess).catch(function () {
      fallbackCopy(value, handleSuccess, handleFailure);
    });
  } else {
    fallbackCopy(value, handleSuccess, handleFailure);
  }
});

function fallbackCopy(text, onSuccess, onFailure) {
  var textarea = document.createElement('textarea');
  textarea.value = text;
  textarea.setAttribute('readonly', '');
  textarea.style.position = 'fixed';
  textarea.style.opacity = '0';
  document.body.appendChild(textarea);
  textarea.select();
  try {
    var successful = document.execCommand('copy');
    if (successful) {
      onSuccess();
    } else {
      onFailure();
    }
  } catch (err) {
    onFailure();
  } finally {
    document.body.removeChild(textarea);
  }
}
</script>

{{ end }}
